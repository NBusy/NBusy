sudo: required
language: go
services:
  - docker
env: GO_ENV=test
go:
  - 1.6.1

before_install:
  - docker build -t nbusy/nbusy .
  - if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ -z "${TRAVIS_TAG}" ]; then
    docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker push docker.io/nbusy/nbusy:latest;
    v=$(echo ${TRAVIS_TAG} | cut -c 2-);
    docker tag nbusy/nbusy nbusy/nbusy:$v
    docker push docker.io/nbusy/nbusy:$v;
    fi

script:
  - go test -v ./...
  - GORACE="halt_on_error=1" go test -v -race -cover ./...
